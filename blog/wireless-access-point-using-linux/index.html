<!DOCTYPE html><html lang="ru"><head>  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-89748707-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-89748707-1'); </script><base href="https://denisnovikov.github.io"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="aiV-7fBXdNhcJILKp5GXFesXJetzCgLWAbif-tZKfrY" /><meta name="yandex-verification" content="41a2ad868168b23f" /><meta name="openstat-verification" content="62f671b1eaa0d2a7ce234219685a42b3d7770961" /><meta property="op:markup_version" content="v1.0"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="application-name" content="FrontEnd Blog"><meta name="format-detection" content="telephone=no"><meta name="generator" content="jekyll"><meta name="google" content="notranslate"><meta name="rating" content="General"><meta name="referrer" content="never"><meta name="robots" content="index,follow,noodp"><meta name="subject" content="blog"><meta name="url" content="https://denisnovikov.github.io"><meta name="viewport" content="width=device-width, initial-scale=1"><title> Беспроводная точка доступа, используя Linux - denisnovikov.github.io</title><meta name="description" content="Что ж, вот и первая статья из обещанной серии."><link rel="alternate" hreflang="ru" href="/blog/wireless-access-point-using-linux/" /><link rel="canonical" href="https://denisnovikov.github.io/blog/wireless-access-point-using-linux/"><link rel="author" href="DNovikov"><link rel="me" href="https://github.com/denisnovikov" type="text/html"><link rel="me" href="mailto:dnovikov1808@gmail.com"><link href='https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|Roboto+Condensed:700&subset=latin' rel='stylesheet' type='text/css'><link rel="stylesheet" href="/assets/css/main.css"><meta property="og:url" content="https://denisnovikov.github.io/blog/wireless-access-point-using-linux/"><meta property="og:type" content="website"><meta property="og:title" content="Беспроводная точка доступа, используя Linux"><meta property="og:description" content="Первое, что я буду делать — настраивать Software AP, или беспроводную сеть на базе компьютера"><meta property="og:site_name" content="denisnovikov.github.io"><meta property="og:locale" content="ru_RU"><meta property="article:author" content="DNovikov"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@dev_novikov"><meta name="twitter:creator" content="@dev_novikov"><meta name="twitter:url" content="https://denisnovikov.github.io/blog/wireless-access-point-using-linux/"><meta name="twitter:title" content="Беспроводная точка доступа, используя Linux"><meta name="twitter:description" content="Первое, что я буду делать — настраивать Software AP, или беспроводную сеть на базе компьютера"><meta property="og:image" content="https://denisnovikov.github.io/assets/images/bg.svg"><meta name="twitter:image" content="https://denisnovikov.github.io/assets/images/bg.svg"><body><div id="shadow"></div><header class="main-header content-wrapper"> <input type="checkbox" id="menu-checkbox" /><nav class="center-wrapper nav-main"> <a class="blog-logo" href="/">denisnovikov.github.io</a> <a href="/about/">О проекте</a> <a href="/blog/">Все записи блога</a> <a href="/feed.xml" rel="alternate" type="application/rss+xml">RSS</a> <label for="menu-checkbox" class="toggle-button" data-open="☰" data-close="☰" onclick></label></nav></header><aside class="sidebar" role="note" style=" background-image: url( /assets/images/linux/wireless-access-point-using-linux/preview-wireless-access-point-using-linux.png )"><div class="cover"><div class="cover-text"><div class="heading"> <a href="/blog/#linux">linux</a></div><p> Первое, что я буду делать — настраивать Software AP, или беспроводную сеть на базе компьютера Беспроводная точка доступа, используя Linux</div></div><div id="switcher"></div></aside><main class="content-wrapper"><article class="post"><h1 class="post-title">Беспроводная точка доступа, используя Linux</h1><p class="post-meta"> <time datetime="2013-08-02">02-08-2013</time> &nbsp;/&nbsp; <span>habrahabr.ru</span><div class="post-content"><p>Что ж, вот и первая статья из обещанной серии.<p>Первое, что я буду делать — настраивать Software AP, или беспроводную сеть на базе компьютера. На этом этапе, конечно, нужен доступ к консоли сервера с правами рута. Кроме того, нужно также подключение к интернету НЕ через внутреннюю вайфай-карточку — кабелем, через 3G-модем, короче, как пожелаете, но только не по вайфаю, который мы будем использовать для создания беспроводной сети. Я на первое время подключил и сервер, и ноут, с которого управлял сервером, в одну сеть по кабелю — так надёжнее всё-таки. Буду использовать пакет hostapd — он довольно известен как надёжное решение и мануалов под него достаточно, а для DHCP и DNS серверов буду использовать dnsmasq — решение как раз под домашние сети, его использует DD-WRT, не удивлюсь, если кто-то ещё.<h2 id="Самый-первый-шаг-конечно-же">Самый первый шаг, конечно же</h2><p>Установка:<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>apt-get install hostapd</code></pre></figure><p>Версия:<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>hostapd <span class="nt">-v</span><br data-jekyll-commonmark-ghpages="" />hostapd v1.0</code></pre></figure><p>Мда, в исходниках уже есть 2.0. Такой он, Debian stable. Но на самом деле это нам не особо помешает — версия 1.0 у меня работает достаточно стабильно.<h2 id="Настройка">Настройка</h2><p>Отредактировать файл /etc/default/hostapd.conf. В нём раскомментировать строку вида<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">DAEMON_CONF</span>=<span class="s2">"/etc/hostapd/hostapd.conf"</span></code></pre></figure><p>Это путь к файлу конфигурации демона hostapd.<p>Затем идем дальше — редактировать <code class="highlighter-rouge">/etc/hostapd/hostapd.conf</code>. Предоставлю содержимое моего файла конфигурации. Предупреждаю, парсер конфигурационных опций у этого демона очень чувствителен и ругается даже на пустые строки с пробелом. На комментарии не ругается.<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">interface</span>=<span class="n">wlan0</span></code></pre></figure><p>Сетевой интерфейс беспроводной карты<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">driver</span>=<span class="n">nl80211</span></code></pre></figure><p>Драйвер сетевой карты — обычно для hostapd отлично работает nl80211, не вижу смысла менять, да и говорят, что он работает в большинстве случаев.<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">ssid</span>=<span class="n">CRWiFi</span></code></pre></figure><p>Название точки доступа, т.н. SSID<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">hw_mode</span>=<span class="n">g</span></code></pre></figure><p>Режим работы сетевой карты — 801.11b/g/n. На самом деле — там всегда должно оставаться g, даже если карта способна на n, для настройки режима n придётся кое-что поменять, смотрите дальше:<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="c">#ieee80211n=1 #Раскомментировать для включения режима n<br data-jekyll-commonmark-ghpages="" /></span><span class="err">#</span><span class="n">ht_capab</span>=[<span class="n">HT40</span>-][<span class="n">SHORT</span>-<span class="n">GI</span>-<span class="m">40</span>] <span class="err">#</span>Раскомментировать для включения режима <span class="n">n</span></code></pre></figure><figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">channel</span>=<span class="m">6</span></code></pre></figure><p>Беспроводной канал — от 1 до 13. Для лучшей производительности рекомендуются 1, 6 или 11 канал.<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">wpa</span>=<span class="m">2</span></code></pre></figure><p><strong>Версия WPA</strong><figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">wpa_passphrase</span>=<span class="m">11111111</span></code></pre></figure><h3 id="Пароль-беспроводной-точки">Пароль беспроводной точки</h3><p><strong>Дополнительные настройки WPA2:</strong><figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">wpa_key_mgmt</span>=<span class="n">WPA</span>-<span class="n">PSK</span><br data-jekyll-commonmark-ghpages="" /><span class="n">wpa_pairwise</span>=<span class="n">TKIP</span><br data-jekyll-commonmark-ghpages="" /><span class="n">rsn_pairwise</span>=<span class="n">CCMP</span><br data-jekyll-commonmark-ghpages="" /><span class="n">auth_algs</span>=<span class="m">1</span></code></pre></figure><p>Следующая опция устанавливает блокировку MAC-адресов. Пока не знаю, как это настроить, да и штука довольно бесполезная, но все говорят, что без блокировки эту опцию нужно выставить в ноль — что я и сделал:<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">macaddr_acl</span>=<span class="m">0</span></code></pre></figure><p>Полный конфиг одним блоком для копипаста в файл:<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">interface</span>=<span class="n">wlan0</span><br data-jekyll-commonmark-ghpages="" /><span class="n">driver</span>=<span class="n">nl80211</span><br data-jekyll-commonmark-ghpages="" /><span class="n">ssid</span>=<span class="n">CRWiFi</span><br data-jekyll-commonmark-ghpages="" /><span class="n">hw_mode</span>=<span class="n">g</span><br data-jekyll-commonmark-ghpages="" /><span class="c">#ieee80211n=1 #Раскомментировать для включения режима n<br data-jekyll-commonmark-ghpages="" />#ht_capab=[HT40-][SHORT-GI-40] #Раскомментировать для включения режима n<br data-jekyll-commonmark-ghpages="" /></span><span class="n">channel</span>=<span class="m">6</span><br data-jekyll-commonmark-ghpages="" /><span class="n">wpa</span>=<span class="m">2</span><br data-jekyll-commonmark-ghpages="" /><span class="n">wpa_passphrase</span>=<span class="m">11111111</span><br data-jekyll-commonmark-ghpages="" /><span class="n">wpa_key_mgmt</span>=<span class="n">WPA</span>-<span class="n">PSK</span><br data-jekyll-commonmark-ghpages="" /><span class="n">wpa_pairwise</span>=<span class="n">TKIP</span><br data-jekyll-commonmark-ghpages="" /><span class="n">rsn_pairwise</span>=<span class="n">CCMP</span><br data-jekyll-commonmark-ghpages="" /><span class="n">auth_algs</span>=<span class="m">1</span><br data-jekyll-commonmark-ghpages="" /><span class="n">macaddr_acl</span>=<span class="m">0</span></code></pre></figure><p>Конфиг автоматически проверяется перед запуском, так что — смело пробуйте запустить hostapd. Команды управления:<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="c"># /etc/init.d/hostapd start<br data-jekyll-commonmark-ghpages="" /># /etc/init.d/hostapd stop<br data-jekyll-commonmark-ghpages="" /></span><span class="err">#</span> /<span class="n">etc</span>/<span class="n">init</span>.<span class="n">d</span>/<span class="n">hostapd</span> <span class="n">restart</span></code></pre></figure><p>Напомню — также в Debian можно использовать команды вида service hostapd start, что легче в написании.<h2 id="Пару-шагов-для-устойчивости">Пару шагов для устойчивости</h2><ul><li>Нельзя забывать, что для шифрования WPA/WPA2 пароль должен быть не короче 8 символов. Если поменять пароль на лету, используя SSH сессию через беспроводной канал, можно внезапно отрезать себя от сервера — hostapd не захочет запускаться и единственное средство связи с сервером будет потеряно. Работает — не трогай, ну а если трогаешь — трогай осторожно.<li>В случае многопользовательской системы советую поставить права чтения файлов вида 700, чтобы простые пользователи не могли узнать пароль для точки доступа — если вас это волнует, конечно.</ul><p>Что ещё могу сказать? С мобильными устройствами проблем нет, с ноутбуком под Windows 7 — крайне редко (примерно раз-два в месяц) не получается подключиться к точке. Лечится командой service hostapd restart, велика вероятность, что в новых релизах эта проблема убрана — есть версия hostapd 2.0.0, но компилировать и ставить её я пока что не пытался.<p>Пока всё. К точке можно попробовать подключиться, но… Для успешного подключения к точке доступа нужен DHCP сервер, без него к точке полноценно не подключишься — те же операционные системы не дадут этого сделать, поскольку без получения адреса само подключение не имеет особого смысла. Вот его и настроим!<hr /><p>Когда я только начинал учиться настраивать сервера под свои нужды, первое, на что я тогда я наткнулся — это пакет isc-dhcp-server, его я и планировал предложить, и статья уже была готова, но… Я нашёл dnsmasq, и моя жизнь изменилась в лучшую сторону. Dnsmasq — это и кэширующий DNS, и DHCP сервер со своим набором различных фич. Как только я заглянул в его конфиг, мое зрение улучшилось, все мысли в мозгу внезапно стали упорядоченными и я достиг просветления. Реально, конфиг очень простой и понятный. Но пока подготавливаем площадку для работы dnsmasq. Что же делать?<hr /><p>Придумать, как будут выглядеть адреса в нашей локальной сети. Я выбрал адреса типа 192.168.51.x.<hr /><p>Настроить сетевой интерфейс, на котором будет работать dnsmasq. На самом деле — очень важный шаг, который пропускают многие в своих мануалах по настройке DHCP-серверов. Дело в том, что компьютеру, на котором работает DHCP-сервер, необходимо прописать статический адрес — кто выдаст адрес DHCP-серверу, если он сам не может запуститься без адреса, а адрес себе он выдать не может, потому что не запущен?<p>Итак, открываем для редактирования файл /etc/network/interfaces и добавляем туда абзац вида:<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">auto</span> наш<span class="err">_</span>интерфейс<br data-jekyll-commonmark-ghpages="" /><span class="n">iface</span> наш<span class="err">_</span>интерфейс <span class="n">inet</span> <span class="n">static</span><br data-jekyll-commonmark-ghpages="" /><span class="n">address</span> <span class="m">192</span>.<span class="m">168</span>.х.<span class="m">1</span><br data-jekyll-commonmark-ghpages="" /><span class="n">netmask</span> <span class="m">255</span>.<span class="m">255</span>.<span class="m">255</span>.<span class="m">0</span><br data-jekyll-commonmark-ghpages="" /><span class="n">gateway</span> <span class="m">192</span>.<span class="m">168</span>.х.<span class="m">1</span></code></pre></figure><p>Сохраняем и перезапускаем наш сетевой интерфейс, на котором настроен DHCP:<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">ifdown</span> интерфейс<br data-jekyll-commonmark-ghpages="" /><span class="n">ifup</span> интерфейс</code></pre></figure><p>Проверяем состояние, сверяем настройки с теми, что должны быть:<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">ifconfig</span> интерфейс</code></pre></figure><hr /><p>Нужно удалить любые DNS и DHCP серверы, чтобы dnsmasq мог спокойно запуститься — иначе выдаёт ошибку. У меня были установлены bind9 и isc-dhcp-server, пришлось избавиться от них. Если работаем по SSH из сети, в которой раньше адреса раздавал покойный DHCP-сервер, не перезагружаемся — выдавать адреса уже некому.<hr /><p>Нужно создать условия для работы сервера — создать пользователя для того, чтобы под ним запускать dnsmasq, прописать в системных настройках DNS-сервера, к которым dnsmasq будет обращаться и ещё пару мелочей.<p>Прописываем DNS сервера Гугла. Правда, первой строчкой у нас будет localhost. Это сделано для того, чтобы остальные системные приложения на нашем же сервере, когда им надо получить адрес от DNS-сервера, обращались сначала к dnsmasq, а не к Гуглу. Ну а dnsmasq достаточно умён, чтобы игнорировать эту строчку:<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>nano /etc/resolv.conf</code></pre></figure><figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">nameserver</span> <span class="m">127</span>.<span class="m">0</span>.<span class="m">0</span>.<span class="m">1</span><br data-jekyll-commonmark-ghpages="" /><span class="n">nameserver</span> <span class="m">8</span>.<span class="m">8</span>.<span class="m">8</span>.<span class="m">8</span><br data-jekyll-commonmark-ghpages="" /><span class="n">nameserver</span> <span class="m">8</span>.<span class="m">8</span>.<span class="m">8</span>.<span class="m">4</span></code></pre></figure><p>Нужно защитить это файл от перезаписи при каждом запуске системы. Перезаписывает его dhclient, если что. Честно говоря, блокировка от записи — лишь один из способов того, как не допустить перезапись =) Есть и другие, но этот самый простой:<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>chattr +i /etc/resolv.conf</code></pre></figure><p>Что же, если вы по каким-либо причинам считаете блокирование файла неверным путём или также хотите использовать DNS, которые столь настойчиво предлагает dhclient? Тогда, как советует <a href="http://habrahabr.ru/users/merlin-vrn/">@merlin-vrn</a>, нужно использовать программу resolvconf.<p><strong>Настройка resolvconf</strong><p>Если пакет resolvconf ещё не установлен, устанавливаем. Единственное, что нужно для того, чтобы прописать статический адрес DNS для системы — отредактировать /etc/resolvconf/resolv.conf.d/base, вписав туда всё, что мы бы вписали в <code class="highlighter-rouge">/etc/resolv.conf</code>:<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">nameserver</span> <span class="m">127</span>.<span class="m">0</span>.<span class="m">0</span>.<span class="m">1</span><br data-jekyll-commonmark-ghpages="" /><span class="n">nameserver</span> <span class="m">8</span>.<span class="m">8</span>.<span class="m">8</span>.<span class="m">8</span><br data-jekyll-commonmark-ghpages="" /><span class="n">nameserver</span> <span class="m">8</span>.<span class="m">8</span>.<span class="m">4</span>.<span class="m">4</span></code></pre></figure><p><code class="highlighter-rouge">service resolvconf reload</code> — готово!<p>Добавляем группу и пользователя:<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># groupadd -r dnsmasq</span><br data-jekyll-commonmark-ghpages="" /><span class="c"># useradd -r -g dnsmasq dnsmasq</span></code></pre></figure><hr /><p>Ставим Dnsmasq, он запускается и готов к работе, но мы его отключаем — ещё не настроен, нечего ему тут делать:<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># apt-get install dnsmasq</span><br data-jekyll-commonmark-ghpages="" /><span class="c"># service dnsmasq stop</span></code></pre></figure><hr /><p>Чистим оригинальный файл от стандартного конфига:<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># echo ""&gt;/etc/dnsmasq.conf</span></code></pre></figure><p>Ну а теперь мы готовы настраивать. Скажу сразу — у dnsmasq много разных опций, которые я при написании статьи подробно описывал в комментариях… Пока не понял, что топик раздулся до неприличных и нечитаемых размеров, как будто недостаточно того, что статья и так переполнена текстом и отформатирована, как кусок незнамо чего. Поэтому — я оставлю конфиг с самыми важными без длинных комментариев и всяких дополнительных опций, а конфиг с дополнительными опциями будет под спойлером.<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="c"># Заставим dnsmasq запускаться исключительно под пользователем dnsmasq<br data-jekyll-commonmark-ghpages="" /></span><span class="n">user</span>=<span class="n">dnsmasq</span><br data-jekyll-commonmark-ghpages="" /><span class="n">group</span>=<span class="n">dnsmasq</span><br data-jekyll-commonmark-ghpages="" /><span class="c">##<br data-jekyll-commonmark-ghpages="" /># Настраиваем DNS. Не нужен - смело выкидываем эту часть<br data-jekyll-commonmark-ghpages="" />##<br data-jekyll-commonmark-ghpages="" /># Настройка DNS - чтобы отключить DNS, поставьте тут 0<br data-jekyll-commonmark-ghpages="" /># Если же хотите расположить DNS на нестандартном порту - что ж, располагайте<br data-jekyll-commonmark-ghpages="" /></span><span class="n">port</span>=<span class="m">53</span><br data-jekyll-commonmark-ghpages="" /><br data-jekyll-commonmark-ghpages="" /><span class="c"># Размер кэша. Число обозначает количество хранимых доменных имён<br data-jekyll-commonmark-ghpages="" /></span><span class="n">cache</span>-<span class="n">size</span>=<span class="m">1000</span><br data-jekyll-commonmark-ghpages="" /><br data-jekyll-commonmark-ghpages="" /><span class="c"># Не спрашивать у внешнего DNS про имена без точки вроде homeserver, user-pc и прочие -<br data-jekyll-commonmark-ghpages="" /># ему и так плохо, бедному, а ещё мы тут со своими заведомо локальными адресами...<br data-jekyll-commonmark-ghpages="" /></span><span class="n">domain</span>-<span class="n">needed</span><br data-jekyll-commonmark-ghpages="" /><span class="c"># Что-то вроде предыдущего, тоже не даёт обращаться к глобальным DNS-серверам со всякой нелепицей в запросе<br data-jekyll-commonmark-ghpages="" /></span><span class="n">bogus</span>-<span class="n">priv</span><br data-jekyll-commonmark-ghpages="" /><br data-jekyll-commonmark-ghpages="" /><span class="c"># Интерфейс для приёма DHCP и DNS запросов.<br data-jekyll-commonmark-ghpages="" /></span><span class="n">interface</span>=<span class="n">wlan0</span><br data-jekyll-commonmark-ghpages="" /><span class="c"># А вот этого интерфейса избегать, как чумы:<br data-jekyll-commonmark-ghpages="" /></span><span class="n">except</span>-<span class="n">interface</span>=<span class="n">ppp0</span><br data-jekyll-commonmark-ghpages="" /><span class="c"># На всякий случай, мало ли глюк и сервер реально будет раздавать на ppp0, размахивая своим dhcp-authoritative.<br data-jekyll-commonmark-ghpages="" /></span><br data-jekyll-commonmark-ghpages="" /><span class="c">##<br data-jekyll-commonmark-ghpages="" /># Настраиваем DHCP. НЕ нужен - смело выкидываем эту часть.<br data-jekyll-commonmark-ghpages="" />##<br data-jekyll-commonmark-ghpages="" /># Одна из самых главных строчек:<br data-jekyll-commonmark-ghpages="" /># она своим лишь присутствием запускает DHCP-сервер,<br data-jekyll-commonmark-ghpages="" /># заодно передавая ему размер пула адресов<br data-jekyll-commonmark-ghpages="" /># 12h значит то, что срок аренды адреса по умолчанию - 12 часов.<br data-jekyll-commonmark-ghpages="" /># Соответственно, 12m - 12 минут, всё просто.<br data-jekyll-commonmark-ghpages="" /></span><span class="n">dhcp</span>-<span class="n">range</span>=<span class="m">192</span>.<span class="m">168</span>.<span class="m">51</span>.<span class="m">50</span>,<span class="m">192</span>.<span class="m">168</span>.<span class="m">51</span>.<span class="m">150</span>,<span class="m">12</span><span class="n">h</span><br data-jekyll-commonmark-ghpages="" /><br data-jekyll-commonmark-ghpages="" /><span class="c"># Статический адрес. Указаны только MAC и IP:<br data-jekyll-commonmark-ghpages="" /></span><span class="n">dhcp</span>-<span class="n">host</span>=<span class="m">11</span>:<span class="m">22</span>:<span class="m">33</span>:<span class="m">44</span>:<span class="m">55</span>:<span class="m">66</span>,<span class="m">192</span>.<span class="m">168</span>.<span class="m">51</span>.<span class="m">60</span><br data-jekyll-commonmark-ghpages="" /><span class="c"># Статический адрес. Указаны MAC, hostname, IP и индивидуальное время аренды.<br data-jekyll-commonmark-ghpages="" /># Да-да, вы поняли тему =) Всё решается одной строчкой:<br data-jekyll-commonmark-ghpages="" /></span><span class="n">dhcp</span>-<span class="n">host</span>=<span class="m">11</span>:<span class="m">22</span>:<span class="m">33</span>:<span class="m">44</span>:<span class="m">55</span>:<span class="m">66</span>,<span class="n">fred</span>,<span class="m">192</span>.<span class="m">168</span>.<span class="m">51</span>.<span class="m">60</span>,<span class="m">45</span><span class="n">m</span><br data-jekyll-commonmark-ghpages="" /><br data-jekyll-commonmark-ghpages="" /><span class="c"># Заблокировать выдачу IP-адреса для этого MAC-адреса:<br data-jekyll-commonmark-ghpages="" /></span><span class="n">dhcp</span>-<span class="n">host</span>=<span class="m">11</span>:<span class="m">22</span>:<span class="m">33</span>:<span class="m">44</span>:<span class="m">55</span>:<span class="m">66</span>,<span class="n">ignore</span><br data-jekyll-commonmark-ghpages="" /><span class="c"># Я лучше заблокирую - не, ну он выглядит реально подозрительно!<br data-jekyll-commonmark-ghpages="" /></span><br data-jekyll-commonmark-ghpages="" /><span class="c"># Объявляем, что наш сервер - властитель нашей локальной сети и ни один другой не может быть подобным ему.<br data-jekyll-commonmark-ghpages="" /># НЕ ДЕЛАЙТЕ ЭТОГО, если есть такие же самопровозглашённые претенденты на трон -<br data-jekyll-commonmark-ghpages="" /># можно порушить королевство, где выдаются IP-адреса<br data-jekyll-commonmark-ghpages="" /># А вот для моего сервера это необходимо, чтобы уменьшить время получения IP для устройств<br data-jekyll-commonmark-ghpages="" /></span><span class="n">dhcp</span>-<span class="n">authoritative</span></code></pre></figure><p>Расширенные опции:<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="c"># А тут можно немного подкорректировать то, что отдаёт DNS.<br data-jekyll-commonmark-ghpages="" /># IPv4-only.<br data-jekyll-commonmark-ghpages="" /># Поправим 1.2.3.4 на 5.6.7.8!<br data-jekyll-commonmark-ghpages="" /></span><span class="n">alias</span>=<span class="m">1</span>.<span class="m">2</span>.<span class="m">3</span>.<span class="m">4</span>,<span class="m">5</span>.<span class="m">6</span>.<span class="m">7</span>.<span class="m">8</span><br data-jekyll-commonmark-ghpages="" /><span class="c"># А если 1.2.3.x на 5.6.7.x? Ну тут уже нужна маска сети!<br data-jekyll-commonmark-ghpages="" /></span><span class="n">alias</span>=<span class="m">1</span>.<span class="m">2</span>.<span class="m">3</span>.<span class="m">0</span>,<span class="m">5</span>.<span class="m">6</span>.<span class="m">7</span>.<span class="m">0</span>,<span class="m">255</span>.<span class="m">255</span>.<span class="m">255</span>.<span class="m">0</span><br data-jekyll-commonmark-ghpages="" /><span class="c"># Ну а если мы вообще хотим перенаправить блок 192.168.0.10-&gt;192.168.0.40 на 10.0.0.10-&gt;10.0.0.40?<br data-jekyll-commonmark-ghpages="" /></span><span class="n">alias</span>=<span class="m">192</span>.<span class="m">168</span>.<span class="m">0</span>.<span class="m">10</span>-<span class="m">192</span>.<span class="m">168</span>.<span class="m">0</span>.<span class="m">40</span>,<span class="m">10</span>.<span class="m">0</span>.<span class="m">0</span>.<span class="m">0</span>,<span class="m">255</span>.<span class="m">255</span>.<span class="m">255</span>.<span class="m">0</span><br data-jekyll-commonmark-ghpages="" /><span class="c"># Всё, можно устраивать у себя свой Spamhaus и блокировать целыми блоками адресов, перенаправляя на что-нибудь ещё.<br data-jekyll-commonmark-ghpages="" /></span><br data-jekyll-commonmark-ghpages="" /><span class="c"># Небольшой срыв покровов. Dnsmasq открывает порты на всех интерфейсах -<br data-jekyll-commonmark-ghpages="" /># даже если сказано только про некоторые. Затем он просто игнорирует ненужные.<br data-jekyll-commonmark-ghpages="" /># Это, как говорят, сделано для удобства. Если честно - мне кажется, что<br data-jekyll-commonmark-ghpages="" /># в нашем случае никакого удобства не будет.<br data-jekyll-commonmark-ghpages="" /># Следующая опция принуждает dnsmasq не притворяться и слушать только на тех интерфейсах,<br data-jekyll-commonmark-ghpages="" /># которые реально предназначены для этого.<br data-jekyll-commonmark-ghpages="" /></span><span class="n">bind</span>-<span class="n">interfaces</span><br data-jekyll-commonmark-ghpages="" /><br data-jekyll-commonmark-ghpages="" /><span class="c"># Интересная настройка! У нас же DNS, хоть и использующий общую базу адресов -<br data-jekyll-commonmark-ghpages="" /># а это значит, что он может отдавать такие запросы, какие мы его попросим.<br data-jekyll-commonmark-ghpages="" /># Угадайте, что делает эта опция?<br data-jekyll-commonmark-ghpages="" /></span><span class="n">address</span>=/<span class="n">vk</span>.<span class="n">com</span>/<span class="m">127</span>.<span class="m">0</span>.<span class="m">0</span>.<span class="m">1</span><br data-jekyll-commonmark-ghpages="" /><span class="c"># Даа! Вместо ВК будет показываться гордое "It works!"<br data-jekyll-commonmark-ghpages="" /># Ходют тут всякие, трафик наш тратят.<br data-jekyll-commonmark-ghpages="" /># Ну и что, что безлимитный? =D<br data-jekyll-commonmark-ghpages="" /># Использоваться, конечно, может не только для блокировки на уровне DNS,<br data-jekyll-commonmark-ghpages="" /># но и для того, чтобы просто задать сетевое имя машине в локальной сети.<br data-jekyll-commonmark-ghpages="" /></span><br data-jekyll-commonmark-ghpages="" /><span class="c"># Стоп, а зачем делать это в самом конфиге?<br data-jekyll-commonmark-ghpages="" /># Одна из прикольных фишек dnsmasq как DNS-сервера:<br data-jekyll-commonmark-ghpages="" /># читать файл /etc/hosts и все записи из него отдавать на соответствующие DNS-запросы.<br data-jekyll-commonmark-ghpages="" /># Можно не только удовлетворять запросы активизации KMS Microsoft Office<br data-jekyll-commonmark-ghpages="" /># и прочего софта с онлайн-активацией,<br data-jekyll-commonmark-ghpages="" /># но и блокать рекламу ещё до того, как она дойдёт до нашего сервера.<br data-jekyll-commonmark-ghpages="" /># Ну а зачем пихать всё сразу в hosts? Можно добавить внешний файлик с записями! И не один!<br data-jekyll-commonmark-ghpages="" /></span><span class="n">addn</span>-<span class="n">hosts</span>=/<span class="n">etc</span>/<span class="n">banner_add_hosts</span><br data-jekyll-commonmark-ghpages="" /><span class="c"># Естественно, он по синтаксису должен быть в точности как hosts.<br data-jekyll-commonmark-ghpages="" /># А если идея c hosts, на ваш взгляд, неуместна, некультурна и вообще моветон?<br data-jekyll-commonmark-ghpages="" /># Используйте следующую опцию и отключите эту фишку.<br data-jekyll-commonmark-ghpages="" /></span><span class="n">no</span>-<span class="n">hosts</span><br data-jekyll-commonmark-ghpages="" /><br data-jekyll-commonmark-ghpages="" /><span class="c"># Интересная фишка, подходящая для ноутбуков с двумя сетевыми картами - проводной и беспроводной.<br data-jekyll-commonmark-ghpages="" /># Заключается она в том, что на два разных MAC-адреса выдаётся один IP-адрес.<br data-jekyll-commonmark-ghpages="" /># Правда, при этом подразумевается то, что два типа связи не будут использоваться одновременно -<br data-jekyll-commonmark-ghpages="" /># если подключатся оба, то адрес получит второй MAC в строке.<br data-jekyll-commonmark-ghpages="" /># Всё очень просто - MA:CA:DD:RE:SS:00,MA:CA:DD:RE:SS:01,12.34.56.78<br data-jekyll-commonmark-ghpages="" /></span><span class="n">dhcp</span>-<span class="n">host</span>=<span class="m">11</span>:<span class="m">22</span>:<span class="m">33</span>:<span class="m">44</span>:<span class="m">55</span>:<span class="m">66</span>,<span class="m">12</span>:<span class="m">34</span>:<span class="m">56</span>:<span class="m">78</span>:<span class="m">90</span>:<span class="m">12</span>,<span class="m">192</span>.<span class="m">168</span>.<span class="m">0</span>.<span class="m">60</span><br data-jekyll-commonmark-ghpages="" /><br data-jekyll-commonmark-ghpages="" /><span class="c"># Дать бесконечный lease клиенту c hostname bert.<br data-jekyll-commonmark-ghpages="" /></span><span class="n">dhcp</span>-<span class="n">host</span>=<span class="n">bert</span>,<span class="m">192</span>.<span class="m">168</span>.<span class="m">0</span>.<span class="m">70</span>,<span class="n">infinite</span><br data-jekyll-commonmark-ghpages="" /><br data-jekyll-commonmark-ghpages="" /><span class="c"># На закуску - эта опция отвечает за "белый список".<br data-jekyll-commonmark-ghpages="" /># Всё просто - адреса будут выдаваться только тем, кому вы выдали статический в этом файле.<br data-jekyll-commonmark-ghpages="" /># Остальные со своими грязными DHCPDISCOVER пролетают.<br data-jekyll-commonmark-ghpages="" /></span><span class="n">dhcp</span>-<span class="n">ignore</span>=<span class="n">tag</span>:!<span class="n">known</span><br data-jekyll-commonmark-ghpages="" /><br data-jekyll-commonmark-ghpages="" /><span class="c"># Размер пула DHCP-адресов. Интересно, почему эта настройка не задаётся согласно address range.<br data-jekyll-commonmark-ghpages="" /></span><span class="n">dhcp</span>-<span class="n">lease</span>-<span class="n">max</span>=<span class="m">640</span> <span class="c">#640 адресов хватит каждому<br data-jekyll-commonmark-ghpages="" /># На самом деле - большинству вообще не понадобится больше 100, но это мелочи.<br data-jekyll-commonmark-ghpages="" /></span><br data-jekyll-commonmark-ghpages="" /><span class="c"># Интересная опция. Запускает скрипт при каждой выдаче адреса DHCP и истечении срока выдачи<br data-jekyll-commonmark-ghpages="" /># Аргументы: script add MA:CA:DD:RE:SS:00 12.34.56.78 hostname(если есть) (при добавлении)<br data-jekyll-commonmark-ghpages="" /># или script del MA:CA:DD:RE:SS:00 12.34.56.78 hostname(если есть) (при удалении)<br data-jekyll-commonmark-ghpages="" /></span><span class="n">dhcp</span>-<span class="n">script</span>=/<span class="n">bin</span>/<span class="n">echo</span><br data-jekyll-commonmark-ghpages="" /><span class="c"># Если подумать - есть пара интересных применений. Вроде голосового оповещения при подключении =D<br data-jekyll-commonmark-ghpages="" /></span><br data-jekyll-commonmark-ghpages="" /><span class="c"># Адрес NTP-сервера для машин в сети. Ещё не поставил - но обязательно поставлю, делов-то.<br data-jekyll-commonmark-ghpages="" /></span><span class="n">dhcp</span>-<span class="n">option</span>=<span class="m">42</span>,<span class="m">192</span>.<span class="m">168</span>.<span class="m">51</span>.<span class="m">1</span></code></pre></figure><p>Ага, сервер настроен. Запускаем:<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># service dnsmasq start</span></code></pre></figure><p>и смотрим на наличие ошибок в выводе команды. Если нет — всё отлично! Пробуем что-нибудь подключить к нашей точке и смотрим, как выдаются IP-адреса, пингуем и проверяем DNS. Файл со списком выданных адресов: <code class="highlighter-rouge">/var/lib/misc/dnsmasq.leases</code>.<p>В следующей статье — подключение 3G-модема и конфигурация простого, но стабильного NAT/firewall на iptables. Удачной настройки!<p>Критика по содержанию, удобочитаемости и форматированию статьи более, чем уместна.<p align="right"><small><em>Источник: https://habrahabr.ru/post/188274/</em></small><div class="post-links"> <a class="link-to-post" href="/blog/why-dont-trust-cases/"> <span class="link-to-post__next">&#10535; &nbsp;Next post</span> <span class="link-to-post__title">Почему не стоит слишком доверять кейсам?</span> </a> <a class="link-to-post" href="/blog/articles-about-portable-server-on-linux-for-beginners-do-we-need-it/"> <span class="link-to-post__prev">&#10535; &nbsp;Previous post</span> <span class="link-to-post__title">Статьи про переносной сервер на Linux для новичков — нужны ли?</span> </a></div></div></article></main><footer class="blog-footer content-wrapper"><p>&copy; <span class="full-year"></span> denisnovikov.github.io</footer><script src="/assets/js/scripts.js"></script>  <script type="text/javascript"> (function (d, w, c) { (w[c] = w[c] || []).push(function () { try { w.yaCounter45975960 = new Ya.Metrika({ id: 45975960, clickmap: true, trackLinks: true, accurateTrackBounce: true, webvisor: true }); } catch (e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = "https://mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks"); </script> <noscript><div> <img src="https://mc.yandex.ru/watch/45975960" style="position:absolute; left:-9999px;" alt="" /></div></noscript>  <!--Openstat--> <span id="openstat1"></span> <script type="text/javascript"> var openstat = { counter: 1, next: openstat }; (function(d, t, p) { var j = d.createElement(t); j.async = true; j.type = "text/javascript"; j.src = ("https:" == p ? "https:" : "http:") + "//openstat.net/cnt.js"; var s = d.getElementsByTagName(t)[0]; s.parentNode.insertBefore(j, s); })(document, "script", document.location.protocol); </script> <!--/Openstat-->
